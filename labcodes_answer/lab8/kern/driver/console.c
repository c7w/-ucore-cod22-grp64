#include <console.h>
#include <defs.h>
#include <sbi.h>
#include <sync.h>

#include <unistd.h>

#define ll long long

#define WIDTH 100
#define HEIGHT 75
#define FPS 10
#define SECOND 60
#define VIDEO_LENGTH FPS * SECOND


typedef unsigned char uint8_t;

typedef unsigned int uint32_t;
/*
 * rasterized font mapping
 */
uint8_t fonts[0xFF][0xF] = {
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x00 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x01 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x02 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x03 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x04 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x05 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x06 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x07 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x08 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x09 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x0A <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x0B <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x0C <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x0D <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x0E <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x0F <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x10 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x11 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x12 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x13 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x14 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x15 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x16 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x17 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x18 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x19 <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x1A <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x1B <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x1C <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x1D <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x1E <not printable>
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // ASCII: 0x1F <not printable>
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x20  
0x00, 0x00, 0x0C, 0x0C, 0x0C, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x0C, 0x00, 0x00, 0x00,   // ASCII: 0x21 !
0x00, 0x00, 0x12, 0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x22 "
0x00, 0x00, 0x24, 0x24, 0x7F, 0x32, 0x12, 0x12, 0x3F, 0x12, 0x11, 0x19, 0x00, 0x00, 0x00,   // ASCII: 0x23 #
0x08, 0x08, 0x3E, 0x2B, 0x2B, 0x0B, 0x0E, 0x38, 0xA8, 0x29, 0x2B, 0x3E, 0x08, 0x08, 0x00,   // ASCII: 0x24 $
0x00, 0x00, 0x47, 0x24, 0x34, 0x17, 0x08, 0x74, 0x4C, 0x4A, 0x49, 0x71, 0x00, 0x00, 0x00,   // ASCII: 0x25 %
0x00, 0x00, 0x1E, 0x93, 0xA3, 0x02, 0x06, 0x6D, 0x29, 0x11, 0x39, 0xEE, 0x00, 0x00, 0x00,   // ASCII: 0x26 &
0x00, 0x00, 0x0C, 0x0C, 0x0C, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x27 '
0x20, 0x38, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0C, 0x38, 0x20, 0x00,   // ASCII: 0x28 (
0x02, 0x06, 0x0C, 0x08, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x08, 0x0C, 0x06, 0x02, 0x00,   // ASCII: 0x29 )
0x00, 0x00, 0x00, 0x08, 0x08, 0x69, 0x3F, 0x0C, 0x16, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x2A *
0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x88, 0x7F, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x2B +
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x04, 0x06,   // ASCII: 0x2C ,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x2D -
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00, 0x00, 0x00,   // ASCII: 0x2E .
0x20, 0x20, 0x30, 0x10, 0x18, 0x18, 0x08, 0x0C, 0x04, 0x04, 0x06, 0x02, 0x02, 0x03, 0x00,   // ASCII: 0x2F /
0x00, 0x00, 0x1E, 0x33, 0x21, 0x21, 0x2D, 0x21, 0x21, 0x21, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x30 0
0x00, 0x00, 0x0C, 0x0B, 0x09, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x7F, 0x00, 0x00, 0x00,   // ASCII: 0x31 1
0x00, 0x00, 0x1E, 0x33, 0x21, 0x20, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x3F, 0x00, 0x00, 0x00,   // ASCII: 0x32 2
0x00, 0x00, 0x3F, 0x30, 0x18, 0x0C, 0x1C, 0x20, 0x20, 0x21, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x33 3
0x00, 0x00, 0x18, 0x08, 0x0C, 0x06, 0x22, 0x23, 0x21, 0x3F, 0x20, 0x20, 0x00, 0x00, 0x00,   // ASCII: 0x34 4
0x00, 0x00, 0x3F, 0x03, 0x03, 0x1F, 0x33, 0x20, 0x20, 0x20, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x35 5
0x00, 0x00, 0x18, 0x0C, 0x04, 0x1E, 0x32, 0x21, 0x61, 0x21, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x36 6
0x00, 0x00, 0x7F, 0x61, 0x21, 0x30, 0x10, 0x18, 0x18, 0x08, 0x0C, 0x04, 0x00, 0x00, 0x00,   // ASCII: 0x37 7
0x00, 0x00, 0x1E, 0x33, 0x21, 0x23, 0x1E, 0x36, 0x21, 0x61, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x38 8
0x00, 0x00, 0x1E, 0x33, 0x21, 0x61, 0x23, 0x3E, 0x10, 0x18, 0x08, 0x0C, 0x00, 0x00, 0x00,   // ASCII: 0x39 9
0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00, 0x00, 0x00,   // ASCII: 0x3A :
0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x04, 0x06,   // ASCII: 0x3B ;
0x00, 0x00, 0x00, 0x00, 0x30, 0x1C, 0x07, 0x03, 0x0E, 0x38, 0x20, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x3C <
0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x3D =
0x00, 0x00, 0x00, 0x00, 0x03, 0x0E, 0x38, 0x20, 0x18, 0x06, 0x01, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x3E >
0x00, 0x00, 0x1E, 0x30, 0x30, 0x30, 0x1C, 0x04, 0x04, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00,   // ASCII: 0x3F ?
0x00, 0x00, 0x1E, 0x23, 0x41, 0x59, 0x6D, 0x4D, 0x4D, 0x4D, 0x6D, 0x59, 0x01, 0x03, 0x1E,   // ASCII: 0x40 @
0x00, 0x00, 0x0C, 0x1C, 0x14, 0x16, 0x12, 0x32, 0x3E, 0x23, 0x21, 0x61, 0x00, 0x00, 0x00,   // ASCII: 0x41 A
0x00, 0x00, 0x1F, 0x33, 0x23, 0x23, 0x1F, 0x33, 0x23, 0x23, 0x33, 0x1F, 0x00, 0x00, 0x00,   // ASCII: 0x42 B
0x00, 0x00, 0x1E, 0x33, 0x23, 0x03, 0x03, 0x03, 0x03, 0x23, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x43 C
0x00, 0x00, 0x1F, 0x33, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x33, 0x1F, 0x00, 0x00, 0x00,   // ASCII: 0x44 D
0x00, 0x00, 0x3F, 0x03, 0x03, 0x03, 0x3F, 0x03, 0x03, 0x03, 0x03, 0x3F, 0x00, 0x00, 0x00,   // ASCII: 0x45 E
0x00, 0x00, 0x3F, 0x03, 0x03, 0x03, 0x3F, 0x03, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00,   // ASCII: 0x46 F
0x00, 0x00, 0x1E, 0x33, 0x23, 0x03, 0x03, 0x3B, 0x23, 0x23, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x47 G
0x00, 0x00, 0x23, 0x23, 0x23, 0x23, 0x3F, 0x23, 0x23, 0x23, 0x23, 0x23, 0x00, 0x00, 0x00,   // ASCII: 0x48 H
0x00, 0x00, 0x3F, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F, 0x00, 0x00, 0x00,   // ASCII: 0x49 I
0x00, 0x00, 0x3C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x21, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x4A J
0x00, 0x00, 0x63, 0x33, 0x13, 0x1B, 0x0F, 0x1B, 0x13, 0x33, 0x23, 0x63, 0x00, 0x00, 0x00,   // ASCII: 0x4B K
0x00, 0x00, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x7E, 0x00, 0x00, 0x00,   // ASCII: 0x4C L
0x00, 0x00, 0x33, 0x33, 0x35, 0x35, 0x2D, 0x29, 0x21, 0x21, 0x21, 0x21, 0x00, 0x00, 0x00,   // ASCII: 0x4D M
0x00, 0x00, 0x23, 0x27, 0x25, 0x25, 0x2D, 0x2B, 0x2B, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00,   // ASCII: 0x4E N
0x00, 0x00, 0x1E, 0x33, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x4F O
0x00, 0x00, 0x1F, 0x23, 0x63, 0x63, 0x23, 0x3F, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00,   // ASCII: 0x50 P
0x00, 0x00, 0x1E, 0x33, 0x23, 0x21, 0x21, 0x21, 0x21, 0x23, 0x33, 0x1E, 0x10, 0x30, 0x20,   // ASCII: 0x51 Q
0x00, 0x00, 0x1F, 0x33, 0x63, 0x23, 0x3F, 0x1B, 0x13, 0x33, 0x33, 0x63, 0x00, 0x00, 0x00,   // ASCII: 0x52 R
0x00, 0x00, 0x1E, 0x33, 0x23, 0x03, 0x0E, 0x38, 0x20, 0x21, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x53 S
0x00, 0x00, 0x7F, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00,   // ASCII: 0x54 T
0x00, 0x00, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x55 U
0x00, 0x00, 0x61, 0x21, 0x23, 0x32, 0x32, 0x12, 0x16, 0x14, 0x1C, 0x0C, 0x00, 0x00, 0x00,   // ASCII: 0x56 V
0x00, 0x00, 0x4D, 0x4D, 0x4D, 0x6D, 0x75, 0x35, 0x35, 0x35, 0x33, 0x33, 0x00, 0x00, 0x00,   // ASCII: 0x57 W
0x00, 0x00, 0xE3, 0xB2, 0x16, 0x1C, 0x0C, 0x0C, 0x1C, 0x12, 0x33, 0x61, 0x00, 0x00, 0x00,   // ASCII: 0x58 X
0x00, 0x00, 0x61, 0x23, 0x32, 0x16, 0x1C, 0x0C, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00,   // ASCII: 0x59 Y
0x00, 0x00, 0xBF, 0x30, 0x10, 0x18, 0x08, 0x0C, 0x06, 0x02, 0x03, 0x3F, 0x00, 0x00, 0x00,   // ASCII: 0x5A Z
0x1C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x1C, 0x00, 0x00,   // ASCII: 0x5B [
0x01, 0x03, 0x02, 0x06, 0x06, 0x04, 0x0C, 0x08, 0x08, 0x18, 0x10, 0x10, 0x30, 0x20, 0x00,   // ASCII: 0x5C 
0x1E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1E, 0x00, 0x00,   // ASCII: 0x5D ]
0x00, 0x08, 0x0C, 0x14, 0x12, 0x32, 0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x5E ^
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x00, 0x00,   // ASCII: 0x5F _
0x00, 0x06, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x60 `
0x00, 0x00, 0x00, 0x00, 0x1E, 0x33, 0x20, 0x3E, 0x23, 0x21, 0x33, 0x2E, 0x00, 0x00, 0x00,   // ASCII: 0x61 a
0x00, 0x00, 0x03, 0x03, 0x1F, 0x33, 0x23, 0x23, 0x23, 0x23, 0x33, 0x1F, 0x00, 0x00, 0x00,   // ASCII: 0x62 b
0x00, 0x00, 0x00, 0x00, 0x1E, 0x33, 0x23, 0x03, 0x03, 0x23, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x63 c
0x00, 0x00, 0x20, 0x20, 0x2E, 0x33, 0x23, 0x23, 0x23, 0x23, 0x33, 0x2E, 0x00, 0x00, 0x00,   // ASCII: 0x64 d
0x00, 0x00, 0x00, 0x00, 0x1E, 0x33, 0x21, 0x3F, 0x01, 0x03, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x65 e
0x00, 0x00, 0x78, 0x0C, 0x04, 0x7F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00,   // ASCII: 0x66 f
0x00, 0x00, 0x00, 0x00, 0x2E, 0x33, 0x23, 0x23, 0x23, 0x23, 0x33, 0x2E, 0x20, 0x20, 0x1E,   // ASCII: 0x67 g
0x00, 0x00, 0x03, 0x03, 0x1F, 0x33, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x00, 0x00, 0x00,   // ASCII: 0x68 h
0x00, 0x18, 0x18, 0x00, 0x0F, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x7F, 0x00, 0x00, 0x00,   // ASCII: 0x69 i
0x00, 0x30, 0x30, 0x00, 0x1F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x18, 0x0F,   // ASCII: 0x6A j
0x00, 0x00, 0x03, 0x03, 0x63, 0x33, 0x1B, 0x0F, 0x1B, 0x13, 0x33, 0x63, 0x00, 0x00, 0x00,   // ASCII: 0x6B k
0x00, 0x00, 0x07, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0C, 0x78, 0x00, 0x00, 0x00,   // ASCII: 0x6C l
0x00, 0x00, 0x80, 0x00, 0x37, 0x6D, 0x69, 0x69, 0x69, 0x69, 0x69, 0x69, 0x00, 0x00, 0x00,   // ASCII: 0x6D m
0x00, 0x00, 0x00, 0x00, 0x1F, 0x33, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x00, 0x00, 0x00,   // ASCII: 0x6E n
0x00, 0x00, 0x00, 0x00, 0x1E, 0x33, 0x23, 0x23, 0x23, 0x23, 0x33, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x6F o
0x00, 0x00, 0x00, 0x00, 0x1F, 0x33, 0x23, 0x23, 0x23, 0x23, 0x33, 0x1F, 0x03, 0x03, 0x03,   // ASCII: 0x70 p
0x00, 0x00, 0x00, 0x00, 0x2E, 0x33, 0x23, 0x23, 0x23, 0x23, 0x33, 0x2E, 0x20, 0x20, 0x20,   // ASCII: 0x71 q
0x00, 0x00, 0x00, 0x00, 0x3F, 0x33, 0x63, 0x03, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00,   // ASCII: 0x72 r
0x00, 0x00, 0x00, 0x00, 0x1E, 0x23, 0x03, 0x0E, 0x38, 0x20, 0x23, 0x3E, 0x00, 0x00, 0x00,   // ASCII: 0x73 s
0x00, 0x00, 0x04, 0x04, 0x3F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0C, 0x38, 0x00, 0x00, 0x00,   // ASCII: 0x74 t
0x00, 0x00, 0x00, 0x00, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x32, 0x1E, 0x00, 0x00, 0x00,   // ASCII: 0x75 u
0x00, 0x00, 0x00, 0x00, 0x61, 0x23, 0x23, 0x32, 0x16, 0x16, 0x1C, 0x0C, 0x00, 0x00, 0x00,   // ASCII: 0x76 v
0x00, 0x00, 0x00, 0x00, 0x4D, 0x4D, 0x6D, 0x2D, 0x35, 0x35, 0x33, 0x32, 0x00, 0x00, 0x00,   // ASCII: 0x77 w
0x00, 0x00, 0x00, 0x00, 0xE3, 0x32, 0x1E, 0x0C, 0x0C, 0x16, 0x32, 0x63, 0x00, 0x00, 0x00,   // ASCII: 0x78 x
0x00, 0x00, 0x00, 0x00, 0x61, 0x23, 0x32, 0x32, 0x16, 0x1C, 0x0C, 0x0C, 0x0C, 0x04, 0x06,   // ASCII: 0x79 y
0x00, 0x00, 0x00, 0x00, 0x3F, 0x30, 0x18, 0x08, 0x0C, 0x06, 0x03, 0x3F, 0x00, 0x00, 0x00,   // ASCII: 0x7A z
0x30, 0x08, 0x08, 0x08, 0x08, 0x08, 0x07, 0x08, 0x08, 0x08, 0x08, 0x08, 0x38, 0x00, 0x00,   // ASCII: 0x7B {
0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00,   // ASCII: 0x7C |
0x07, 0x0C, 0x0C, 0x04, 0x04, 0x0C, 0x38, 0x0C, 0x04, 0x04, 0x0C, 0x0C, 0x07, 0x00, 0x00,   // ASCII: 0x7D }
0x00, 0x00, 0x00, 0x00, 0x00, 0x27, 0x2D, 0x39, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // ASCII: 0x7E ~
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF  // ASCII: 0x7F <not printable>
};


#define X_COUNT 50
#define Y_COUNT 20
#define S_BUFFER_LEN 4096
#define DISPLAY_MEMORY_LEN (300 * 400 / 8)

/*
 * Font matrix 20 * 50
 *    (0, 0)--------> x
 *    |
 *    |
 *    |
 *    V
 *    y
 *  
 *   a single glyph is 15 * 8, which is 15 bytes
 */

/*
 * display buffer
 */
int tail = 0;
ll prev_time = -1;
uint8_t m_buffer[DISPLAY_MEMORY_LEN];
char monitor[Y_COUNT][X_COUNT] = {0};
extern int enable_ft = 1;
extern int enable_display = 1;
int x = 0, y = 0;  // current cursor
int last_r_tick = -1;


#define next(x) ((x == Y_COUNT - 1) ? 0: x + 1)
#define prev(x) ((x == 0) ? (Y_COUNT - 1) : (x - 1))

void _color_use(int use) {
    if (use) {
        enable_display = 0;
        set_display(1);
    } else {
        enable_display = 1;
        set_display(0);
    }
}

/*
 * render `c` @ (x, y)
 */
void render(uint8_t x, uint8_t y, char c) {
    if (x >= X_COUNT) {
        enable_ft = 0;
        cprintf("[X VIO %d %c]", x, c);
        enable_ft = 1;
    }
    if (y >= Y_COUNT) {
        enable_ft = 0;
        cprintf("[Y VIO %d %c]", y, c);
        enable_ft = 1;
    }
    // enable_ft = 0;
    // cprintf("Render (%d, %d), %c\n", x, y, c);
    // enable_ft = 1;

    if (c == 0) {
        c = ' ';
    }

    for (int i = 0; i < 15; ++i) {
        uint8_t *adr = m_buffer + 50 * 15 * y + x + 50 * i;
        *adr = fonts[c][i];
    }
}

ll get_time() {
    int* mtime = 0x200BFF8;
    int* mtime_upper = 0x200BFFC;
    ll time = ((ll)(*mtime_upper) << 32) + *mtime;
    return time;
}

void display_s_buffer() {
    for (int i = next(y), cnt = 0; cnt < Y_COUNT; ++cnt, i = next(i)) {
        int j = 0;
        if (i != y) {
            for (; j < X_COUNT && monitor[i][j] != '\n'; ++j) {
                render(j, cnt, monitor[i][j]);
            }
        } else {
            for (; j < X_COUNT && j < x; ++j) {
                render(j, cnt, monitor[i][j]);
            }
        }
        
        for (; j < X_COUNT; ++j){
            render(j, cnt, ' ');
        }
    }
    set_display(0);
    for (int i = 0; i < DISPLAY_MEMORY_LEN; i += 4) {
        *(uint32_t *)(0x81000000 + i) = *(uint32_t *)((uint8_t *)(m_buffer) + i);
    }
}

void append_c(char c) {
    if (c == '\r') {
        x = 0;
        return;
    }
    monitor[y][x] = c;
    if (c == '\n' || x == X_COUNT - 1) {
        y = next(y);
        x = 0;
    } else {
        x = x + 1;
    }
}

/*
 * Set display mode, 1 for 8-bit colored, 0 for binary
 */
void set_display(int mode) {
    *(int *)(0x81003ffc) = mode;
}

void clear() {
    for (int i = 0; i < DISPLAY_MEMORY_LEN; i += 4) {
        *(int *)(0x81000000 + i) = 0;
    }
}

#define CONSBUFSIZE 512

static struct {
    uint8_t buf[CONSBUFSIZE];
    uint32_t rpos;
    uint32_t wpos;
} cons;

/* *
 * cons_intr - called by device interrupt routines to feed input
 * characters into the circular console input buffer.
 * */
void cons_intr(int (*proc)(void)) {
    int c;
    while ((c = (*proc)()) != -1) {
        if (c != 0) {
            cons.buf[cons.wpos++] = c;
            if (cons.wpos == CONSBUFSIZE) {
                cons.wpos = 0;
            }
        }
    }
}

/* kbd_intr - try to feed input characters from keyboard */
void kbd_intr(void) {
    serial_intr();
}

/* serial_proc_data - get data from serial port */
int serial_proc_data(void) {
    int c = sbi_console_getchar();
    if (c < 0) {
        return -1;
    }
    if (c == 127) {
        c = '\b';
    }
    return c;
}

static inline void try_dislay() {
    if (enable_display) {
        ll now =  get_time();
        if (prev_time == -1) {
            // invalid, pass
            prev_time = now;
        } else if (now - prev_time > 2000000) {
            // clear();
            display_s_buffer();
            prev_time = now;
        }
    }
}

/* serial_intr - try to feed input characters from serial port */
void serial_intr(void) {
    cons_intr(serial_proc_data);
    try_dislay();
}

/* serial_putc - print character to serial port */
void serial_putc(int c) {
    if (c != '\b') {
        sbi_console_putchar(c);
        if (enable_ft) {
            append_c(c);
            try_dislay();
        }
    } else {
        sbi_console_putchar('\b');
        sbi_console_putchar(' ');
        sbi_console_putchar('\b');
    }
}

/* cons_init - initializes the console devices */
void cons_init(void) {
    sbi_console_getchar();
}

/* cons_putc - print a single character @c to console devices */
void cons_putc(int c) {
    bool intr_flag;
    local_intr_save(intr_flag);
    {
        serial_putc(c);
    }
    local_intr_restore(intr_flag);
}

/* *
 * cons_getc - return the next input character from console,
 * or 0 if none waiting.
 * */
int cons_getc(void) {
    int c = 0;
    bool intr_flag;
    local_intr_save(intr_flag);
    {
        // poll for any pending input characters,
        // so that this function works even when interrupts are disabled
        // (e.g., when called from the kernel monitor).
        serial_intr();

        // grab the next character from the input buffer.
        if (cons.rpos != cons.wpos) {
            c = cons.buf[cons.rpos++];
            if (cons.rpos == CONSBUFSIZE) {
                cons.rpos = 0;
            }
        }
    }
    local_intr_restore(intr_flag);
    return c;
}
